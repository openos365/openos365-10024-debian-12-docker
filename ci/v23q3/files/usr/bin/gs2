#!/usr/bin/env bash

set -x

export CMD_PATH=$PWD
export PROJECT_NAME="${CMD_PATH##*/}"
echo $PROJECT_NAME
cd $CMD_PATH

mkdir -p etc/$1
cat>etc/$1/$1.conf<<EOF
PATTERN=act365

EOF

mkdir -p usr/bin/
if [ -d usr/bin/ ];then

cat>usr/bin/$1.start.sh<<EOF
#!/bin/sh

set -x
umask 022
PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/bin
export PATH

pwd

EOF
fi
chmod +x usr/bin/$1.start.sh
cat usr/bin/$1.start.sh

mkdir -p usr/lib/systemd/system/
if [ -d usr/lib/systemd/system ];then

cat>usr/lib/systemd/system/$1.service<<EOF
[Unit]
Description=$1
After=network.target

[Service]

Type=simple
User=root
Group=root

EnvironmentFile=/etc/$1/$1.conf
ExecStart=/usr/bin/$1.start.sh

# Restart=no：退出后不会重启（默认值）
# Restart=on-success：只有正常退出时（退出状态码为 0），才会重启
# Restart=on-failure：非正常退出时，包括被信号终止和超时，才会重启
# Restart=on-abnormal：只有被信号终止和超时，才会重启
# Restart=on-abort：只有在收到没有捕捉到的信号终止时，才会重启
# Restart=on-watchdog：超时退出，才会重启
# Restart=always：不管是什么退出原因，总是重启
Restart=always
RestartSec=120

[Install]
WantedBy=multi-user.target
EOF

fi
cat usr/lib/systemd/system/$1.service
